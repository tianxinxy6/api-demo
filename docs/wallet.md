# 中心化交易所钱包系统 - 需求文档

## 1. 项目概述

### 1.1 项目背景
开发一款类似币安、欧易等主流交易所的中心化钱包系统，支持用户在交易所内进行数字资产的充值、提现、转账等操作。

### 1.2 项目目标
- 构建安全、稳定、高性能的钱包充值系统
- 支持主流稳定币 USDT 的链上充值
- 兼容多链生态（TRC20、ERC20）
- 确保资金安全和用户资产安全
- 提供可扩展的架构，便于未来支持更多币种和链

### 1.3 项目范围
**第一期范围**：
- USDT 充值功能（TRC20、ERC20）
- 用户钱包地址生成与管理
- 链上交易监控与确认
- 充值到账处理

**未来扩展**：
- 提现功能
- 更多币种支持（BTC、ETH、其他 ERC20 代币）
- 更多链支持（BSC、Polygon 等）
- 钱包内部转账

---

## 2. 功能需求

### 2.1 用户钱包管理

#### 2.1.1 钱包地址生成
- **需求描述**：用户首次充值时，系统自动为其生成独立的充值地址
- **业务规则**：
  - 每个用户每条链拥有独立的充值地址
  - TRC20 地址格式：以 `T` 开头的 Base58 编码地址
  - ERC20 地址格式：以 `0x` 开头的 42 位十六进制地址
  - 地址与用户账户永久绑定
  - 支持用户查看自己的充值地址和二维码

#### 2.1.2 钱包地址管理
- 地址状态管理（启用/禁用）
- 地址使用记录追踪
- 地址余额查询（仅用于监控，不作为账户余额）

### 2.2 充值功能

#### 2.2.1 充值地址展示
- 用户可查看不同链的充值地址
- 显示充值地址二维码
- 明确提示支持的代币和链
- 显示最小充值金额
- 显示预计到账时间和所需确认数

#### 2.2.2 链上充值监控
- **TRC20 监控**：
  - 实时监听 TRON 网络上的 USDT 转账事件
  - 监控用户充值地址的入账交易
  - 识别交易哈希、发送方、金额、时间戳
  
- **ERC20 监控**：
  - 实时监听 Ethereum 网络上的 USDT 转账事件
  - 监控用户充值地址的入账交易
  - 识别交易哈希、发送方、金额、时间戳、Gas 费用

#### 2.2.3 交易确认机制
- **TRC20 确认**：
  - 需要 19 个区块确认（约 57 秒）
  - 临时到账：1 个确认后显示充值记录（待确认状态）
  - 最终到账：19 个确认后资金可用
  
- **ERC20 确认**：
  - 需要 12 个区块确认（约 2.4 分钟）
  - 临时到账：1 个确认后显示充值记录（待确认状态）
  - 最终到账：12 个确认后资金可用

#### 2.2.4 充值到账处理
- 验证交易有效性（是否为 USDT 合约地址）
- 计算实际到账金额
- 更新用户账户余额
- 生成充值记录
- 发送充值成功通知

#### 2.2.5 充值记录
- 记录每笔充值的详细信息：
  - 交易哈希
  - 链类型（TRC20/ERC20）
  - 充值地址
  - 发送方地址
  - 充值金额
  - 确认数
  - 交易状态（待确认/已确认/失败）
  - 到账时间
  - 区块高度

### 2.3 账户余额管理

#### 2.3.1 余额更新
- 充值确认后实时更新用户余额
- 支持余额变动通知
- 余额变动日志记录

#### 2.3.2 余额查询
- 用户可查询当前可用余额
- 查询充值中的待确认金额
- 查询历史充值记录

### 2.4 通知功能

#### 2.4.1 充值通知
- 充值交易检测到时发送通知
- 充值到账时发送通知
- 支持多种通知渠道（站内信、邮件、短信、推送）

---

## 3. 安全需求

### 3.1 私钥安全

#### 3.1.1 密钥生成
- 使用安全的随机数生成器生成私钥
- 私钥生成环境需在安全隔离的服务器
- 使用 HSM（硬件安全模块）或 KMS（密钥管理服务）

#### 3.1.2 密钥存储
- **冷热钱包分离**：
  - 热钱包：存储少量资金用于日常提现（未来功能）
  - 冷钱包：存储大部分用户资金，离线保管
- 私钥加密存储，采用多重加密
- 使用信封加密（Envelope Encryption）
- 主密钥（MEK）由 KMS 管理
- 数据密钥（DEK）加密实际私钥

#### 3.1.3 密钥使用
- 私钥仅在必要时加载到内存
- 使用完毕立即清除内存
- 操作审计日志完整记录

### 3.2 资金安全

#### 3.2.1 充值风控
- 识别异常大额充值
- 检测高频充值行为
- 黑名单地址拦截
- 可疑交易人工审核

#### 3.2.2 地址安全
- 定期检查地址余额，及时归集到冷钱包
- 异常转出实时告警
- 地址私钥定期轮换机制（可选）

#### 3.2.3 资金归集策略
- 热钱包余额达到阈值时自动归集到冷钱包
- 归集操作需多重签名
- 归集记录完整审计

### 3.3 系统安全

#### 3.3.1 访问控制
- API 接口认证和授权
- 基于角色的权限控制（RBAC）
- 敏感操作需要二次验证

#### 3.3.2 数据安全
- 敏感数据加密存储
- 数据库访问审计
- 定期数据备份
- 数据脱敏处理（日志中不显示完整地址和金额）

#### 3.3.3 网络安全
- 服务器部署在私有网络
- 使用防火墙限制访问
- API 网关限流和防护
- DDoS 防护

### 3.4 合规性

#### 3.4.1 KYC/AML
- 用户实名认证
- 大额交易报告
- 可疑交易监控
- 配合监管机构调查

---

## 4. 性能需求

### 4.1 交易处理能力
- 支持每秒处理 1000+ 充值监控请求
- 充值到账延迟 < 1 分钟（区块确认后）
- 系统响应时间 < 200ms

### 4.2 并发能力
- 支持 10,000+ 用户同时在线
- 支持 1,000+ 并发 API 请求

### 4.3 可用性
- 系统可用性 99.9%+
- 支持主备切换，故障恢复时间 < 5 分钟

---

## 5. 技术需求

### 5.1 区块链节点
- 自建 TRON 全节点或使用可靠的第三方服务
- 自建 Ethereum 全节点或使用可靠的第三方服务
- 节点高可用部署，至少 2 个节点互为备份

### 5.2 数据库
- 使用关系型数据库（PostgreSQL/MySQL）存储用户数据
- 使用 Redis 缓存热点数据
- 数据库主从部署，支持读写分离

### 5.3 监控告警
- 系统监控（CPU、内存、磁盘、网络）
- 业务监控（充值成功率、到账延迟）
- 安全监控（异常登录、异常转账）
- 告警及时推送（邮件、短信、钉钉/企业微信）

---

## 6. 非功能性需求

### 6.1 可扩展性
- 架构支持横向扩展
- 支持未来添加新的区块链网络
- 支持添加新的代币

### 6.2 可维护性
- 代码规范，注释完整
- 完善的日志记录
- 清晰的错误处理
- 单元测试覆盖率 > 80%

### 6.3 可审计性
- 所有关键操作记录审计日志
- 日志不可篡改
- 日志保留至少 3 年

---

## 7. 交付物

### 7.1 系统组件
- 钱包服务（Wallet Service）
- 充值监控服务（Deposit Monitor Service）
- 通知服务（Notification Service）
- 管理后台（Admin Dashboard）
- 用户 API（User API）

### 7.2 文档
- 需求文档（本文档）
- 开发计划文档
- 安全设计文档
- 技术架构文档
- API 接口文档
- 部署运维文档
- 用户操作手册

---

## 8. 风险评估

### 8.1 技术风险
- **区块链节点稳定性**：依赖第三方节点可能存在服务中断风险
  - 缓解措施：自建节点 + 多个第三方节点备份
  
- **重放攻击**：同一笔交易被重复处理
  - 缓解措施：交易哈希去重，幂等性设计

### 8.2 安全风险
- **私钥泄露**：可能导致资金被盗
  - 缓解措施：冷热钱包分离、加密存储、访问控制、定期审计
  
- **内部人员作恶**：拥有系统权限的人员恶意操作
  - 缓解措施：权限最小化、操作审计、多人审批、定期审计

### 8.3 业务风险
- **充值未到账**：用户充值但系统未检测到
  - 缓解措施：监控告警、人工补单机制
  
- **错误到账**：将充值记录到错误账户
  - 缓解措施：严格的地址验证、交易记录审计

---

## 9. 成功标准

### 9.1 功能完整性
- ✅ 用户可成功生成充值地址
- ✅ 系统能准确监控链上充值交易
- ✅ 充值能正确到账用户账户
- ✅ 充值记录完整准确

### 9.2 性能指标
- ✅ 充值到账延迟 < 1 分钟（确认后）
- ✅ API 响应时间 < 200ms
- ✅ 系统可用性 > 99.9%

### 9.3 安全指标
- ✅ 无私钥泄露事件
- ✅ 无资金被盗事件
- ✅ 无重大安全漏洞

---

## 10. 附录

### 10.1 相关资源
- TRON 官方文档：https://developers.tron.network/
- Ethereum 官方文档：https://ethereum.org/developers
- USDT（TRC20）合约地址：TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t
- USDT（ERC20）合约地址：0xdAC17F958D2ee523a2206206994597C13D831ec7

### 10.2 术语表
- **冷钱包**：离线存储私钥的钱包，安全性高
- **热钱包**：在线存储私钥的钱包，便于操作但安全性相对较低
- **KMS**：Key Management Service，密钥管理服务
- **HSM**：Hardware Security Module，硬件安全模块
- **RBAC**：Role-Based Access Control，基于角色的访问控制
- **幂等性**：同一操作执行多次与执行一次效果相同

---

**文档版本**：v1.0  
**创建日期**：2025-12-12  
**文档状态**：待评审
